name: Regression – camera calibration

on:
  workflow_dispatch:

jobs:
  calibrate:
    name: ${{ matrix.os }} – FreeMoCap ${{ matrix.freemocap }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false         # don’t cancel the whole matrix if one combo fails
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        freemocap: ["1.5.4", "1.5.3"]
    steps:

    # 1. Checkout *your* repo (contains the helper script)
    - uses: actions/checkout@v4

    # 2. Set up Python once
    - uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    # 3. Cache wheels so you don't re-build OpenCV every run
    - name: Cache pip
      uses: actions/cache@v4
      with:
        key: >-
          pip-${{ runner.os }}-${{ matrix.freemocap }}-${{ hashFiles('**/requirements*.txt') }}
        path: ~/.cache/pip

    # 4. Install the specific FreeMoCap release
    - name: Install FreeMoCap ${{ matrix.freemocap }}
      run: |
        python -m pip install --upgrade pip
        python -m pip install "freemocap==${{ matrix.freemocap }}"

    # 5. Run calibration & emit the TOML file
      # Adapt the helper script path / CLI flags to your repo
    - name: Run sample calibration
      run: |
        python .github/scripts/run_calibration.py \
               --output "calibration_${{ runner.os }}_${{ matrix.freemocap }}.toml"

    # 6. Upload artifact
    - name: Upload calibration
      uses: actions/upload-artifact@v4
      with:
        name: ${{ runner.os }}-${{ matrix.freemocap }}
        path: |
          calibration_${{ runner.os }}_${{ matrix.freemocap }}.toml
